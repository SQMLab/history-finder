<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Method Selection</title>
    <link href="/webjars/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #spinnerOverlay {
            background-color: rgba(255, 255, 255, 0.1); /* Lighter dimming effect */
        }
        .centered-label {
            display: block;       /* Ensures the label occupies the full width */
            text-align: center;   /* Centers the text horizontally */
            white-space: normal;  /* Allows wrapping for long text */
            word-wrap: break-word; /* Break long words if necessary */
            margin: 0 auto;       /* Optional, for alignment consistency */
        }
        #algorithmSection .btn-primary {
            white-space: normal; /* Enable text wrapping */
            max-width: 250px;    /* Limit button width */
        }
        .centered-form-check input {
            vertical-align: middle;   /* Ensures the checkbox is aligned to the middle */
            margin: 0;                /* Removes any default margin around checkboxes */
        }
        .stepper {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        .stepper .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .stepper .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #ccc;
            transform: translateY(-50%);
        }
        .stepper .step.active .circle {
            background-color: #0d6efd;
            color: #fff;
        }
        .stepper .step.completed .circle {
            background-color: #198754;
            color: #fff;
        }
        .stepper .circle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 2px solid #ccc;
            background-color: #f8f9fa;
            color: #000;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="container mt-5">
<div class="stepper">
    <div class="step active" id="step-repository">
        <div class="circle">1</div>
        <div>Repository</div>
    </div>
    <div class="step" id="step-commit">
        <div class="circle">2</div>
        <div>Commit Hash</div>
    </div>
    <div class="step" id="step-file">
        <div class="circle">3</div>
        <div>File</div>
    </div>
    <div class="step" id="step-method">
        <div class="circle">4</div>
        <div>Method</div>
    </div>
    <div class="step" id="step-algorithm">
        <div class="circle">5</div>
        <div>Algorithm</div>
    </div>
</div>
<!-- ARepository Selection Pop Up-->
<div class="modal fade" id="repositoryListModal" tabindex="-1" aria-labelledby="repositoryListModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="repositoryListModalLabel">Selection a Repository</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h4 id="repositoryListHeaderText"></h4>
                <ul id="clonedRepoList" class="list-group"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Section 1 : Repository URL -->
<div id="repositoryUrlSection" class="mt-4" >
    <h4 class="text-center">Repository Selection</h4>
    <div class="mb-3">
        <label for="gitRepoUrl" class="centered-label">
            Example:<br>
            https://github.com/shahidul2k9/commit-trace-oracle<br>
            https://github.com/shahidul2k9/commit-trace-oracle.git<br>
            git@github.com:shahidul2k9/commit-trace-oracle.git<br>
<!--            gh repo clone shahidul2k9/commit-trace-oracle<br>-->
            /home/repository/commit-trace-oracle
        </label>
        <div class="input-group">
            <input type="text" class="form-control" id="gitRepoUrl" placeholder="Enter repository location">
            <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#repositoryListModal" onclick="loadClonedRepositories()">Browse</button>
        </div>
    </div>
    <div class="text-center mt-3">
        <button class="btn btn-primary" onclick="checkoutRepository('')">Next</button>
    </div>
</div>


<!-- Section 3 : Commit Hash Input-->
<div id="startCommitHashSection" class="mt-4 d-none">
    <h4 class="text-center">Commit Hash Selection</h4>
    <div class="mb-3">
        <label for="startCommitHash" class="form-label"></label>
        <div class="input-group">
            <input type="text" class="form-control" id="startCommitHash" placeholder="Enter commit hash" oninput="validateCommitHash()">
            <button class="btn btn-outline-secondary" onclick="fillHead()">HEAD</button>
        </div>
    </div>
    <!-- Buttons horizontally centered and aligned -->
    <div class="d-flex justify-content-center align-items-center mt-3 gap-3">
        <button class="btn btn-secondary" onclick="showRepositoryLocationSection()">Back</button>
        <button class="btn btn-primary" id="startCommitHashNextButton" onclick="showFileSection(true)" disabled>Next</button>
    </div>
</div>

<!-- Section 4 : File Selection-->
<div id="fileSection" class="mt-4 d-none">
    <h4 class="text-center">File Selection</h4>
    <div class="mb-3">
        <label for="fileSearch" class="form-label"></label>
        <div class="input-group">
            <input type="text" class="form-control" id="fileSearch" placeholder="search by file path">
            <button class="btn btn-outline-secondary" onclick="searchFiles()">Search</button>
        </div>
    </div>
    <div id="breadcrumb" class="mb-3">
        <!-- File path breadcrumbs -->
    </div>
    <ul id="fileList" class="list-group">
        <!-- File items will be dynamically generated -->
    </ul>
    <!-- No file found message -->
    <div id="noFileFound" class="text-center mt-4 d-none">
        <p style="font-size: 2em; color: gray; margin-top: 1em; margin-bottom: 1em;">No file found</p>
    </div>

    <!-- Back Button for Section 3 -->
    <div class="text-center mt-3">
        <button class="btn btn-secondary" onclick="showStartCommitHashSection()">Back</button>
    </div>
</div>


<!-- Section 5 : Method Selection-->
<div id="methodSection" class="mt-4 d-none">
    <h4 class="text-center">Method Selection</h4>
    <div class="mb-3">
        <label for="methodSearch" class="form-label"></label>
        <div class="input-group">
            <input type="text" class="form-control" id="methodSearch" placeholder="Search method">
<!--            <button class="btn btn-outline-secondary" onclick="searchMethods()">Search</button>-->
        </div>
    </div>
    <ul id="methodList" class="list-group">
        <!-- Method items will be dynamically generated -->
    </ul>

    <!-- No method found message -->
    <div id="noMethodFound" class="text-center mt-4 d-none">
        <p style="font-size: 2em; color: gray; margin-top: 1em; margin-bottom: 1em;">No method found</p>
    </div>

    <!-- Back Button for Section 3 -->
    <div class="text-center mt-3">
        <button class="btn btn-secondary" onclick="showFileSection(false)">Back</button>
    </div>
</div>


<!-- Section 6 -->
<div id="algorithmSection" class="mt-4 d-none">
    <h4 class="text-center">Select Algorithm</h4>
    <div class="d-flex flex-column align-items-center gap-3 mt-4">
        <button class="btn btn-primary w-50" onclick="runAlgorithm('HISTORY_FINDER')">History Finder</button>
        <button class="btn btn-primary w-50" onclick="runAlgorithm('CODE_SHOVEL')">Code Shovel</button>
        <button class="btn btn-primary w-50" onclick="runAlgorithm('CODE_TRACKER')">Code Tracker</button>
        <button class="btn btn-primary w-50" onclick="runAlgorithm('GIT_FUNC_NAME')">Git Function Name</button>
        <button class="btn btn-primary w-50" onclick="runAlgorithm('GIT_LINE_RANGE')">Git Line Range</button>
    </div>
    <div class="d-flex justify-content-center mt-3">
        <button class="btn btn-secondary" onclick="showMethodList()">Back</button>
    </div>
</div>

<div id="spinnerOverlay" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-light bg-opacity-25 d-flex align-items-center justify-content-center" style="z-index: 1050;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">Error</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="errorModalBody">
                <!-- Error message will be dynamically set -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/webjars/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script>
    const sectionList = ['repositoryUrlSection',  'startCommitHashSection', 'fileSection', 'methodSection', 'algorithmSection'];
    const steps = ['step-repository', 'step-commit', 'step-file', 'step-method', 'step-algorithm'];

    let state = {
        repository: {
            host: '',
            accountName: '',
            repositoryName: '',
            path: ''
        },
        file: '',
        methodList: [],
        methodName: '',
        startLine: '',
        endLine: ''
    };


    // Navigate between sections
  /*  function revealSection(section) {
        <!--        document.querySelectorAll('div[id^="section"]').forEach(div => div.classList.add('d-none'));-->
        sectionList.forEach(s => {
            document.getElementById(s).classList.add('d-none');
        });
        document.getElementById(section).classList.remove('d-none');
    }
*/

    function revealSection(section) {
        sectionList.forEach((s, index) => {
            const element = document.getElementById(s);
            const step = document.getElementById(steps[index]);

            if (s === section) {
                element.classList.remove('d-none');
                step.classList.add('active');
                step.classList.remove('completed');
            } else {
                element.classList.add('d-none');
                if (steps.indexOf(step.id) < steps.indexOf(steps[sectionList.indexOf(section)])) {
                    step.classList.add('completed');
                } else {
                    step.classList.remove('completed', 'active');
                }
            }
        });
    }

    function showRepositoryLocationSection() {
        revealSection('repositoryUrlSection');
    }

    function showStartCommitHashSection() {
        state.file = ''
        revealSection('startCommitHashSection');
    }

    function showFileSection(needToFetch) {
        console.log('revealing file section..')
        if (needToFetch) {
            fetchFileList(state.file)
        }
        revealSection('fileSection');
    }

    function showMethodList() {
        fetchMethodList(state.file)
        revealSection('methodSection');
    }

    function showAlgorithmSection(methodName, startLine, endLine) {
        state.methodName = methodName;
        state.startLine = startLine;
        state.endLine = endLine;
        revealSection('algorithmSection');
    }


    function onSelectFile(file) {
        console.log(`Selected file: ${file}`);
        if (file.toLowerCase().endsWith('.java')) {
            state.file = file;
            showMethodList()
        } else {
            fetchFileList(file)
        }
    }

    function runAlgorithm(algorithm) {
        console.log(`Running algorithm: ${algorithm}`);
        // Pass the selected algorithm to `loadMethodHistory`
        loadMethodHistory(
            state.file,
            state.methodName,
            state.startLine,
            state.endLine,
            algorithm
        );
    }

    // Existing methods for other sections...

    // Attach goToSection2 to "Already Cloned" button
    //document.querySelector('button[onclick="goToSection(2)"]').onclick = goToSection2;





    function validateCommitHash() {
        const commitHashInput = document.getElementById("startCommitHash");
        const nextButton = document.getElementById("startCommitHashNextButton");

        // Check if input is a valid SHA-1 hash or "HEAD"
        const isValidHash = /^[a-fA-F0-9]{40}$/.test(commitHashInput.value) || commitHashInput.value === "HEAD";

        // Enable the "Next" button if the input is valid
        nextButton.disabled = !isValidHash;
    }

    // Function to set "HEAD" as the value
    function fillHead() {
        const commitHashInput = document.getElementById("startCommitHash");
        commitHashInput.value = "HEAD"; // Set "HEAD" as the input value
        validateCommitHash(); // Re-validate the input
    }

    function searchFiles() {
        const filePath = document.getElementById('fileSearch').value;
        onSelectFile(filePath)
    }
    document.getElementById('fileSearch').addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // Prevent the default action of the Enter key
            searchFiles(); // Trigger the searchFiles function
        }
    });

    function searchMethods() {
        const targetMethodName = document.getElementById('methodSearch').value;
        let matchingMethodList = state.methodList.filter(method=> method.methodName.toLowerCase().includes(targetMethodName.toLowerCase()));
        displayMethodList(matchingMethodList)
    }
    document.getElementById('methodSearch').addEventListener('input', function(event) {
        searchMethods();
    });
    function dismissRepositoryListDialog() {
        const modalElement = document.getElementById('repositoryListModal');
        const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);

        if (modalInstance) {
            modalInstance.hide(); // Hides the modal and its backdrop
        }
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
    }

    function checkoutRepository(location) {
        if (location === ''){
            location = document.getElementById('gitRepoUrl').value;
        }
        if (!location) {
            showError('Repository', "Please enter a valid Git repository location.")
            return;
        }

        $.ajax({
            url: '/api/checkout-repository?location=' + location,
            method: 'GET',
            beforeSend: function () {
                showSpinner();
            },
            success: function (response) {
                hideSpinner()
                state.repository = response;
                showStartCommitHashSection();
            },
            error: function (xhr) {
                hideSpinner();
                showErrorModal(xhr);
            }
        });
    }


    // Call API to load cloned repositories
    function loadClonedRepositories() {
        $.ajax({
            url: '/api/repository-list', // URL to Spring MVC backend API
            method: 'GET',
            beforeSend: function () {
                showSpinner();
            },
            success: function (response) {
                hideSpinner()
                const list = document.getElementById('clonedRepoList');
                document.getElementById('repositoryListHeaderText').innerText = 'Repositories scanned from directory ' + response.repositoryPath
                    + '\n Scan directory is configurable in application.yml';
                list.innerHTML = ''; // Clear previous list

                // Dynamically populate the list
                response.repositoryList.forEach(function (repositoryName) {
                    const li = document.createElement('li');
                    li.classList.add('list-group-item');
                    li.textContent = repositoryName;
                    li.onclick = function () {
                        dismissRepositoryListDialog()
                        checkoutRepository(repositoryName)
                    };
                    list.appendChild(li);
                });
            },
            error: function (xhr) {
                hideSpinner();
                showErrorModal(xhr);
            }
        });
    }

    function fetchFileList(path) {
        $.ajax({
            url: '/api/path-list',
            method: 'GET',
            data: {
                startCommitHash: document.getElementById('startCommitHash').value,
                repositoryHostName: state.repository.host,
                repositoryAccountName: state.repository.accountName,
                repositoryName: state.repository.repositoryName,
                repositoryPath: state.repository.path,
                path: path
            },
            beforeSend: function () {
                showSpinner();
            },
            success: function (fileList) {
                hideSpinner()
                const fileListView = document.getElementById('fileList');
                const noFileFoundView = document.getElementById('noFileFound');
                fileListView.innerHTML = ''; // Clear previous list

                if (fileList.length === 0){
                    noFileFoundView.classList.remove('d-none');
                    fileListView.classList.add('d-none');
                }else {
                    noFileFoundView.classList.add('d-none');
                    fileListView.classList.remove('d-none');
                    // Dynamically populate the list
                    fileList.forEach(function (file) {
                        const li = document.createElement('li');
                        li.classList.add('list-group-item');
                        let fileParts = file.split("/");
                        li.textContent = file
                        //li.textContent = fileParts[fileParts.length - 1];
                        li.onclick = function () {
                            onSelectFile(file);
                        };
                        fileListView.appendChild(li);
                    });
                }

            },
            error: function (xhr) {
                hideSpinner();
                showErrorModal(xhr);
            }
        });
    }

    function fetchMethodList(file) {
        $.ajax({
            url: '/api/method-list',
            method: 'GET',
            data:{
                startCommitHash: document.getElementById('startCommitHash').value,
                repositoryHostName: state.repository.host,
                repositoryAccountName: state.repository.accountName,
                repositoryName: state.repository.repositoryName,
                repositoryPath: state.repository.path,
                file: file
            },
            beforeSend: function () {
                showSpinner();
            },
            success: function (response) {
                hideSpinner()
                state.methodList = response
                displayMethodList(response)
            },
            error: function (xhr) {
                hideSpinner();
                showErrorModal(xhr);
            }
        });
    }

    function displayMethodList(methodList){
        const methodListView = document.getElementById('methodList');
        const noMethodFoundView = document.getElementById('noMethodFound');

        methodListView.innerHTML = ''; // Clear previous list

        if (methodList.length === 0){
            noMethodFoundView.classList.remove('d-none');
            methodListView.classList.add('d-none');
        }else {
            noMethodFoundView.classList.add('d-none');
            methodListView.classList.remove('d-none');
            methodList.forEach(function (methodDto) {
                const methodView = document.createElement('li');
                methodView.classList.add('list-group-item');
                methodView.textContent = methodDto.signature;
                methodView.onclick = function () {
                    showAlgorithmSection(methodDto.methodName, methodDto.startLine, methodDto.endLine);
                };
                methodListView.appendChild(methodView);
            });
        }
    }
    function loadMethodHistory(file, methodName, startLine, endLine, tracerName) {
       /*
        $.ajax({
            url: '/ui/method-history',
            method: 'GET',
            data:{
                startCommitHash: document.getElementById('startCommitHash').value,
                repositoryHostName: state.repository.host,
                repositoryAccountName: state.repository.accountName,
                repositoryName: state.repository.repositoryName,
                repositoryPath: state.repository.path,
                file: file,
                methodName: methodName,
                startLine: startLine,
                endLine: endLine,
                tracerName: tracerName

            },
            beforeSend: function () {
                showSpinner();
            },
            success: function (response) {
                hideSpinner()
                console.log(response)
                // Open a new tab
                let newTab = window.open(this.url, '_blank');
                // Write the AJAX response into the new tab
                newTab.document.open();
                newTab.document.write(response);
                newTab.document.close();
            },
            error: function (xhr) {
                hideSpinner();
                showErrorModal(xhr);
            }
        });*/
        let baseUrl = '/ui/method-history';
        let params = new URLSearchParams({
            startCommitHash: document.getElementById('startCommitHash').value,
            repositoryHostName: state.repository.host,
            repositoryAccountName: state.repository.accountName,
            repositoryName: state.repository.repositoryName,
            repositoryPath: state.repository.path,
            file: file,
            methodName: methodName,
            startLine: startLine,
            endLine: endLine,
            tracerName: tracerName
        }).toString();

// Open the URL in a new tab
        let fullUrl = `${baseUrl}?${params}`;
        window.open(fullUrl, '_blank');
    }
    let spinnerTimer; // To track the timeout
    let spinnerStartTime; // To track when the spinner was shown

    function showSpinner() {
        // Record the time when the spinner is shown
        spinnerStartTime = Date.now();

        // Show the spinner
        const spinnerOverlay = document.getElementById('spinnerOverlay');
        spinnerOverlay.classList.remove('d-none');
    }

    function hideSpinner(minimumDelay = 1000) { // Default minimum delay of 500ms
        const elapsedTime = Date.now() - spinnerStartTime;

        // Calculate remaining time to enforce the minimum delay
        const remainingTime = Math.max(minimumDelay - elapsedTime, 0);

        // Use setTimeout to hide the spinner after the remaining time
        spinnerTimer = setTimeout(() => {
            const spinnerOverlay = document.getElementById('spinnerOverlay');
            spinnerOverlay.classList.add('d-none');
        }, remainingTime);
    }

    function showErrorModal(xhr) {
        const msg = xhr.responseJSON?.msg || "Failed to process request";
        showError('Server Error', msg);
    }

    function showError(title, message) {
        document.getElementById('errorModalLabel').innerText = title;
        document.getElementById('errorModalBody').innerText = message;
        const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
        errorModal.show();
    }

</script>
</body>
</html>
