<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Multi-Section Workflow</title>
    <link href="/webjars/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">
<h2>Multi-Section Workflow</h2>

<!-- Section 1 : Repository URL -->
<div id="repositoryUrlSection" class="mt-4">
    <h4>Section 1: Git Repository</h4>
    <div class="mb-3">
        <label for="gitRepoUrl" class="form-label">Enter Git Repository URL:</label>
        <input type="text" class="form-control" id="gitRepoUrl" placeholder="Enter Git repository URL">
    </div>
    <button class="btn btn-primary" onclick="cloneRepository()">Clone Repository</button>
    <button class="btn btn-secondary" onclick="showRepositoryListSection()">Already Cloned</button>
</div>

<!-- Section 2 : Repository List-->
<div id="repositoryListSection" class="mt-4 d-none">
    <h4>Section 2: Select an Existing Repository</h4>
    <ul id="clonedRepoList" class="list-group"></ul>
    <button class="btn btn-secondary mt-3" onclick="showRepositoryUrlSection()">Back</button>
</div>

<!-- Section 3 : Commit Hash Input-->
<div id="startCommitHashSection" class="mt-4 d-none">
    <h4>Section 3: Enter Commit Hash</h4>
    <div class="mb-3">
        <label for="startCommitHash" class="form-label">Commit Hash:</label>
        <div class="input-group">
            <input type="text" class="form-control" id="startCommitHash" placeholder="Enter commit hash">
            <button class="btn btn-outline-secondary" onclick="fillHEAD()">HEAD</button>
        </div>
    </div>
    <button class="btn btn-secondary mt-3" onclick="showRepositoryListSection()">Back</button>
    <button class="btn btn-primary" id="startCommitHashNextButton" onclick="showFileSection()" disabled>Next</button>
</div>

<!-- Section 4 : File Selection-->
<div id="fileSection" class="mt-4 d-none">
    <h4>Section 4: Search and Select Files</h4>
    <div class="mb-3">
        <label for="fileSearch" class="form-label">Search File:</label>
        <div class="input-group">
            <input type="text" class="form-control" id="fileSearch" placeholder="Enter file path">
            <button class="btn btn-outline-secondary" onclick="searchFiles()">Search</button>
        </div>
    </div>
    <div id="breadcrumb" class="mb-3">
        <!-- File path breadcrumbs -->
    </div>
    <ul id="fileList" class="list-group">
        <!-- File items will be dynamically generated -->
    </ul>

    <!-- Back Button for Section 3 -->
    <button class="btn btn-secondary mt-3" onclick="showStartCommitHashSection()">Back</button>
</div>

<!-- Section 5 -->
<div id="algorithmSection" class="mt-4 d-none">
    <h4>Section 5: Select Algorithms</h4>
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="historyFinder" name="algorithms" value="HistoryFinder">
        <label class="form-check-label" for="historyFinder">HistoryFinder</label>
    </div>
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="codeShovel" name="algorithms" value="CodeShovel">
        <label class="form-check-label" for="codeShovel">CodeShovel</label>
    </div>
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="codeTracker" name="algorithms" value="CodeTracker">
        <label class="form-check-label" for="codeTracker">CodeTracker</label>
    </div>
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="gitFuncname" name="algorithms" value="GitFuncName">
        <label class="form-check-label" for="gitFuncname">Git Funcname</label>
    </div>
    <div class="form-check">
        <input class="form-check-input" type="checkbox" id="gitLineRange" name="algorithms" value="GitLineRange">
        <label class="form-check-label" for="gitLineRange">Git Line Range</label>
    </div>
    <button class="btn btn-primary mt-3" onclick="submitAlgorithms()">Next</button>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/webjars/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script>
    const sectionList = ['repositoryUrlSection', 'repositoryListSection', 'startCommitHashSection', 'fileSection', 'algorithmSection'];

    let state = {repositoryName : ''};


    // Navigate between sections
    function revealSection(section) {
<!--        document.querySelectorAll('div[id^="section"]').forEach(div => div.classList.add('d-none'));-->
        sectionList.forEach( s => {
        document.getElementById(s).classList.add('d-none');
        });
        document.getElementById(section).classList.remove('d-none');
    }
      function showRepositoryUrlSection() {
        revealSection('repositoryUrlSection');
    }
    function showRepositoryListSection() {
        loadClonedRepositories(); // Load the list of cloned repositories
        revealSection('repositoryListSection');
    }
    function showStartCommitHashSection() {
        revealSection('startCommitHashSection');
    }

    function showFileSection() {
    console.log('revealing file section..')
        fetchFileList(state.repositoryName, document.getElementById('startCommitHash').value, '')
        revealSection('fileSection');
    }
     function showAlgorithmSection() {
        revealSection('algorithmSection');
    }



      function onSelectFile(file) {
        console.log(`Selected file: ${file}`);
        methodInfo.file = file;
        goToSection(3); // Go to section 3 (Commit Hash)
    }

    // Existing methods for other sections...

    // Attach goToSection2 to "Already Cloned" button
    //document.querySelector('button[onclick="goToSection(2)"]').onclick = goToSection2;
     function cloneRepository() {
            const url = document.getElementById('gitRepoUrl').value;
            if (!url) {
                alert("Please enter a Git repository URL.");
                return;
            }
            // Simulate API call
            setTimeout(() => {
                const success = true; // Replace with actual API result
                if (success) {
                    goToSection(3);
                } else {
                    alert("Failed to clone repository. Try again.");
                }
            }, 2000);
        }



        function fillHEAD() {
            document.getElementById('startCommitHash').value = "HEAD";
            document.getElementById('startCommitHashNextButton').disabled = false;
        }

        function searchFiles() {
            const filePath = document.getElementById('fileSearch').value;
            // Simulate API call
            console.log(`Searching files for: ${filePath}`);
        }

        function submitAlgorithms() {
            const selectedAlgorithms = Array.from(document.querySelectorAll('input[name="algorithms"]:checked')).map(checkbox => checkbox.value);
            if (selectedAlgorithms.length === 0) {
                alert("Please select at least one algorithm.");
                return;
            }
            console.log("Selected algorithms:", selectedAlgorithms);
        }

        // Call API to load cloned repositories
    function loadClonedRepositories() {
        $.ajax({
            url: '/api/repository-list', // URL to Spring MVC backend API
            method: 'GET',
            success: function(response) {
                const list = document.getElementById('clonedRepoList');
                list.innerHTML = ''; // Clear previous list

                // Dynamically populate the list
                response.forEach(function(repo) {
                    const li = document.createElement('li');
                    li.classList.add('list-group-item');
                    li.textContent = repo;
                    li.onclick = function() {
                        console.log(state);
                         state.repositoryName = repo;
                         showStartCommitHashSection();
                    };
                    list.appendChild(li);
                });
            },
            error: function() {
                alert('Failed to load cloned repositories.');
            }
        });
    }

    function fetchFileList(repositoryName, startCommitHash, path) {
        $.ajax({
            url: '/api/path-list?startCommitHash=' + startCommitHash + '&repositoryName=' + repositoryName + '&path=' + path , // URL to Spring MVC backend API
            method: 'GET',
            success: function(response) {
                const list = document.getElementById('fileList');
                list.innerHTML = ''; // Clear previous list

                // Dynamically populate the list
                response.forEach(function(file) {
                    const li = document.createElement('li');
                    li.classList.add('list-group-item');
                    li.textContent = file;
                    li.onclick = function() {
                        onSelectFile(file);
                    };
                    list.appendChild(li);
                });
            },
            error: function() {
                alert('Failed to load file list.');
            }
        });
    }
</script>
<script src="/webjars/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
</body>
</html>
